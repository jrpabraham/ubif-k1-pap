---
title: "K1_CT"
author: "Catherine Thomas"
date: "10/1/2017"
output: html_document
---

## Install missing packages ##

```{r}
setwd("/Users/catherinecthomas/Google Drive/UBIF/UBIF_Deliverables/UBIF_PAP/K1_PAP")
set.seed(47269801)

required.packages <- c("dplyr", "multiwayvcov", "multcomp", "reshape2", "knitr", "Hmisc", "tidyverse", "knitr", "broom", "ggplot2", "ggsignif")
packages.missing <- required.packages[!required.packages %in% installed.packages()[,"Package"]]

if(length(packages.missing) > 0) {install.packages(required.packages, repo="https://cran.cnr.berkeley.edu/")}
lapply(required.packages, library, character.only = TRUE)
```

######################
## Define functions ##
######################

## For 95% CI

```{r}
sem <- function(x) {sd(x, na.rm=TRUE) / sqrt(length(x))}
ci95.norm <- function(x) {
  me <- sem(x) * qnorm(.975)
  c(mean(x) - me, mean(x) + me)
}
ci <- function(x) {sem(x) * 1.96}
```

## RegTest conducts asymptotic tests from linear model ##

```{r}
RegTest <- function(equation, clustvars, hypotheses, data) {

    model <- lm(equation, data = data, na.action = na.omit)

    if (missing(clustvars)) model$vcov <- vcov(model)
    else model$vcov <- cluster.vcov(model, cluster = clustvars)

    model$test <- summary(glht(model, linfct = hypotheses, vcov = model$vcov))$test

    numhyp <- length(hypotheses)

    EST <- matrix(nrow = numhyp, ncol = 4)

    for (i in 1:numhyp) {

        EST[i, 1] <- model$test$coefficients[i]
        EST[i, 2] <- model$test$tstat[i]
        EST[i, 3] <- model$test$sigma[i]
        EST[i, 4] <- model$test$pvalues[i]

    }

    colnames(EST) <- c("Estimate", "Tstat", "SE", "P")

    return(EST)

}

## PermTest returns MC approximations of the exact p-value ##

PermTest <- function(equation, treatvars, clustvars, hypotheses, iterations, data) {

    stopifnot(length(hypotheses) <= 1)

    obsEST <- RegTest(equation, clustvars, hypotheses, data)
    obsStat <- obsEST[1, 2]

    simEST <- matrix(ncol = 4)

    for (i in 1:iterations) {

        simTreat <- data[, treatvars, drop = FALSE]
        simTreat <- simTreat[sample(nrow(simTreat)),]

        simData <- cbind(simTreat, data[, !(names(data) %in% treatvars), drop = FALSE])
        colnames(simData)[1:length(treatvars)] <- treatvars

        simEST <- rbind(simEST, RegTest(equation, clustvars, hypotheses, data = simData))

    }

    simSTAT <- simEST[2:nrow(simEST), 2]
    countSTAT <- matrix(abs(simSTAT) >= abs(obsStat), ncol = 1)

    ExactP <- colSums(countSTAT) / iterations

    EST <- cbind(obsEST, ExactP)

    colnames(EST) <- c("Estimate", "Tstat", "SE", "P", "ExactP")

    return(EST)

}

## FDR returns minimum q-values ##

FDR <- function(pvals, step) {

    if (sum(is.na(pvals) == FALSE) <= 1) {return(pvals)}
    if (missing(step)) {step <- 0.001}

    allpvals <- cbind(as.matrix(pvals), matrix(1:nrow(as.matrix(pvals)), ncol = 1))

    pvals <- na.omit(allpvals)
    nump <- nrow(pvals)

    pvals <- pvals[order(pvals[, 1]), ]
    rank <- matrix(1:nump, ncol = 1)
    pvals <- cbind(pvals, rank, matrix(0, nrow = nump, ncol = 1))

    qval <- 1

    while (qval > 0) {

        qfirst <- qval / (1 + qval)
        fdrtemp <- (qfirst * rank) / nump

        subrank <- which(fdrtemp >= as.matrix(pvals[, 1]))

        if (length(subrank) < 1) {
            numreject <- 0
        } else numreject <- max(subrank)

        qsec <- qfirst * (nump / (nump - numreject))
        fdrtemp <- (qsec * rank) / nump

        subrank <- which(fdrtemp >= as.matrix(pvals[, 1]))

        if (length(subrank) < 1) {
            numreject <- 0
        } else numreject <- max(subrank)

        pvals[which(pvals[, 3] <= numreject), 4] <- qval

        qval <- qval - step

    }

    pvals <- pvals[order(pvals[, 2]), ]

    qvals <- matrix(nrow = nrow(allpvals), ncol = 1)
    qvals[match(pvals[, 2], allpvals[, 2]), 1] <- pvals[, 4]

    return(as.matrix(qvals))

}

## Interact returns a string of interacted variables ##

Interact <- function(d, x) {

    catstring <- ""

    for (var in x) {

        catstring <- paste(catstring, " + ", d, "*", var, sep = "")

    }

    return(substr(catstring, 3, nchar(catstring)))

}

```

```{r}
scale.means= function (df, ..., na.rm=FALSE) {
  vars=unlist(list(...))
  mean_vars=rowMeans(df[,vars], na.rm=na.rm)
  return(mean_vars)
}
```

################
## Clean data ##
################

```{r}
varnames <- as.vector(read.delim(file = "K1__Field_Survey_v34+35_DeID_Coding.csv", sep = ",", header = FALSE, stringsAsFactors = FALSE, na.strings = "", nrows = 1))
k1_df <- read.delim(file = "K1__Field_Survey_v34+35_DeID_Coding.csv", sep = ",", header = FALSE, stringsAsFactors = FALSE, na.strings = "", skip = 2, nrows = 598, col.names = varnames) %>%
  dplyr::select(-NA., -NA..1, -NA..2)
```

```{r}
## Survey meta data ##

k1_df$start.time.mst <- as.POSIXct(as.character(k1_df$V3), format = "%m/%d/%y %H:%M")
k1_df$start.time.eat <- k1_df$start.time.mst + (3600 * 9)

k1_df$end.time.mst <- as.POSIXct(as.character(k1_df$V4), format = "%m/%d/%y %H:%M")
k1_df$end.time.eat <- k1_df$end.time.mst + (3600 * 9)

## Participant ID ##

k1_df$survey.id <- k1_df$V1
k1_df <- k1_df[complete.cases(k1_df$survey.id), ]

nonentry <- c("R_5ZkChbiXDIj6KsK", "R_7N8rNtLsxF5a9on", "R_97Tx2cAjy30fqMR", "R_lYnRvOAJhuax6LS", "R_8dky4iSC7rfEuNc", "R_nczo7KPxLkkKkgo", "R_5j1OiNu3wMp265N", "R_0GYX0scNN16ICfQ", "R_6PoFtAhwvSBNYzi", "R_696kAyWai9bDkFI", "R_hPaLwAaYCnY0l69", "R_oGNBAVexMWYhMml", "R_3rwTGdEULwOGH2y", "R_bhNv0SnArTa32Xe", "R_5txHVIbQY6twLIZ", "R_kaSM6nunZ9Ynatj", "R_0ppcidBVCPaEkXK", "R_oWceQFJG5NnSokN", "R_h5Cw4tvVUeDY8NI", "R_9ib4ASBi450NZPt", "R_mAlfPdxj5GQsJF5", "R_kbW6NDTS1FWXyn3", "R_b1GC7jpoQrJKrFN", "R_5YpNpbPWOxnSNWc", "R_mwLFSjScVyrgs9J", "R_1jbOtmMIrvgTgaE", "R_if5tz3h1N9MzTp2", "R_aFmo1jRrWIwsLjI", "R_2itxVUcUstO3Syp", "R_9LP4exOnWpJ1TrE", "R_cQLu9PDCtFwbn7K", "R_oFl39knSVL3SKpz", "R_11Y1KTzawxBJmvy")
k1_df <- k1_df[!k1_df$survey.id %in% nonentry, ]
```

```{r}
## Labelling (as needed)##

## Treatment assignment ##

k1_df$treat[k1_df$condition == "poor"] <- 0
k1_df$treat[k1_df$condition == "individual"] <- 1
k1_df$treat[k1_df$condition == "community"] <- 2
k1_df$treat <- factor(k1_df$treat, labels = c("Pov", "Ind", "Com"))
k1_df$condition.order <- factor(k1_df$treat, labels = c("Poverty", "Individual", "Community"))

k1_df$pov <- ifelse(k1_df$condition == "poor", 1, 0)
k1_df$ind <- ifelse(k1_df$condition == "individual", 1, 0)
k1_df$com <- ifelse(k1_df$condition == "community", 1, 0)

k1_df$msg1 <- recode(as.numeric(as.factor(k1_df$ORG_MESSAGE)), `2` = 0, `3` = 2)
k1_df$msg2 <- recode(as.numeric(as.factor(k1_df$ORG_MESSAGE_2)), `2` = 0)
k1_df$msg3 <- recode(as.numeric(as.factor(k1_df$ORG_MESSAGE_3)), `3` = 2)
```

# Composite Variable Construction

```{r}
## Self-efficacy ##

for (var in c(k1_df$sel.con, k1_df$sel.pers, k1_df$sel.com, k1_df$sel.prob, k1_df$sel.bett)) {

    var[var < 0] <- NA

}

k1_df$sel.score <- scale(k1_df$sel.con) + scale(k1_df$sel.pers) + scale(k1_df$sel.com) + scale(k1_df$sel.prob) + scale(k1_df$sel.bett)
k1_df$sel.score.z <- scale(k1_df$sel.score)

k1_df$sel.abs <- scale.means(k1_df, "sel.con", "sel.pers", "sel.com", "sel.prob", "sel.bett", na.rm=T)

## Stigma ##

for (var in c(k1_df$jud.fam, k1_df$jud.com, k1_df$jud.judg, k1_df$jud.emb, k1_df$jud.ups)) {

    var[var < 0] <- NA

}

k1_df$sti.score <- scale(6 - k1_df$jud.fam) + scale(6 - k1_df$jud.com) + scale(k1_df$jud.judg) + scale(k1_df$jud.emb) + scale(k1_df$jud.ups)
k1_df$sti.score.z <- scale(k1_df$sti.score)
k1_df$jud.fam.r <- 6 - k1_df$jud.fam
k1_df$jud.com.r <- 6 - k1_df$jud.com

k1_df$sti.abs <- scale.means(k1_df, "jud.fam.r", "jud.com.r", "jud.judg", "jud.emb", "jud.ups", na.rm=T)

# # ## Affect Relationships ## 
# k1_df$por.oth_1_CODE <- recode(as.numeric(k1_df$por.oth_1_CODE, "0='Negative', 1:4='Non-Negative'"))
# k1_df$por.oth_2_CODE <- recode(k1_df$por.oth_1_CODE, "0='Negative', 1:4='Non-Negative'")
# k1_df$por.oth_3_CODE <- recode(k1_df$por.oth_1_CODE, "0='Negative', 1:4='Non-Negative'")
# k1_df$ind.oth_1_CODE <- recode(k1_df$por.oth_1_CODE, "0='Negative', 1:4='Non-Negative'")
# k1_df$ind.oth_2_CODE <- recode(k1_df$por.oth_1_CODE, "0='Negative', 1:4='Non-Negative'")
# k1_df$ind.oth_3_CODE <- recode(k1_df$por.oth_1_CODE, "0='Negative', 1:4='Non-Negative'")
# k1_df$com.oth_1_CODE <- recode(k1_df$por.oth_1_CODE, "0='Negative', 1:4='Non-Negative'")
# k1_df$com.oth_2_CODE <- recode(k1_df$por.oth_1_CODE, "0='Negative', 1:4='Non-Negative'")
# k1_df$com.oth_3_CODE <- recode(k1_df$por.oth_1_CODE, "0='Negative', 1:4='Non-Negative'")
# 
# ms.relat <- k1_df %>%
#   gather(survey.id, rt, matches("_CODE")) %>% # could do X22:X42 or matches("X[0-9]+")
#   mutate(subid = as.numeric(gsub("X", "", subid)))

## Affect ##

for (var in c(k1_df$aff.pos, k1_df$aff.ash, k1_df$aff.pow, k1_df$aff.fina)) {

    var[var < 0] <- NA

}

k1_df$aff.score <- scale(k1_df$aff.pos) + scale(k1_df$aff.pow) + scale(7 - k1_df$aff.ash) + scale(7 - k1_df$aff.fina)
k1_df$aff.score.z <- scale(k1_df$aff.score)

## Video selection ##

k1_df$vid.imp1 <- k1_df$vid.dec1 %in% c(3, 5)
k1_df$vid.imp2 <- k1_df$vid.dec2 %in% c(3, 5)
k1_df$vid.num <- k1_df$vid.imp1 + k1_df$vid.imp2
k1_df$vid.skills <- k1_df$vid.num > 0  # binary of any skills videos selected

## Intertemporal choice ##

k1_df$sav.save <- k1_df$sav.dec > 1
k1_df$sav.save[k1_df$sav.dec < 0] <- NA

k1_df$sav.amt[k1_df$sav.dec == 1] = 0
k1_df$sav.amt[k1_df$sav.dec == 2] = 100
k1_df$sav.amt[k1_df$sav.dec == 3] = 200
k1_df$sav.amt[k1_df$sav.dec < 0] <- NA

## Query theory (savings) ##

que_df <- k1_df[names(k1_df) %in% c("survey.id", "que.rat1", "que.rat2", "que.rat3", "que.rat4", "que.rat5")]

k1_df$que.nonm <- apply(que_df[, 1:5], 1, function(x) length(x[is.na(x) == FALSE]))

que_df <- melt(que_df, id = c("survey.id"))
que_df$variable <- as.numeric(que_df$variable)
que_df <- dcast(que_df[is.na(que_df$value) == FALSE & que_df$value > 0, ], survey.id ~ value, median, value.var = "variable")
names(que_df) <- c("survey.id", "que.mri", "que.mrp")
k1_df <- merge(k1_df, que_df, all.x = TRUE)

k1_df$que.smrd <- (2 * (k1_df$que.mrp - k1_df$que.mri)) / k1_df$que.nonm
k1_df$que.smrd[is.na(k1_df$que.mrp)] <- 1
k1_df$que.smrd[is.na(k1_df$que.mri)] <- -1

# dealing with missing by filling in upper/lower bounds for now

## Message of support ##

k1_df$msg.dec[k1_df$msg.dec < 0] = NA
k1_df$msg.dec <- k1_df$msg.dec - 1

k1_df$msg.emp[k1_df$msg.emp < 0] = NA

k1_df$msg.lik[k1_df$msg.lik < 0] = NA
k1_df$msg.lik <- 7 - k1_df$msg.lik

k1_df$msg.avg <- (k1_df$msg.emp + k1_df$msg.lik) / 2

## Frame evaluation ##

k1_df$eva.poor[k1_df$msg1 == 0] <- k1_df$eva.msg1[k1_df$msg1 == 0]
k1_df$eva.poor[k1_df$msg2 == 0] <- k1_df$eva.msg2[k1_df$msg2 == 0]
k1_df$eva.poor[k1_df$msg3 == 0] <- k1_df$eva.msg3[k1_df$msg3 == 0]

k1_df$eva.ind[k1_df$msg1 == 1] <- k1_df$eva.msg1[k1_df$msg1 == 1]
k1_df$eva.ind[k1_df$msg2 == 1] <- k1_df$eva.msg2[k1_df$msg2 == 1]
k1_df$eva.ind[k1_df$msg3 == 1] <- k1_df$eva.msg3[k1_df$msg3 == 1]

k1_df$eva.com[k1_df$msg1 == 2] <- k1_df$eva.msg1[k1_df$msg1 == 2]
k1_df$eva.com[k1_df$msg2 == 2] <- k1_df$eva.msg2[k1_df$msg2 == 2]
k1_df$eva.com[k1_df$msg3 == 2] <- k1_df$eva.msg3[k1_df$msg3 == 2]

k1_df$eva.vid.poor <- k1_df$eva.rank.vid_8
k1_df$eva.vid.ind <- k1_df$eva.rank.vid_9
k1_df$eva.vid.com <- k1_df$eva.rank.vid_10

k1_df$eva.conf[k1_df$eva.conf < 0] <- NA

k1_df$eva.emp.poor <- k1_df$eva.rank.emp_5
k1_df$eva.emp.ind <- k1_df$eva.rank.emp_6
k1_df$eva.emp.com <- k1_df$eva.rank.emp_7

## Ladder scales ##

k1_df$ses.lad.now[k1_df$ses.lad.now < 0] <- NA
k1_df$ses.lad.now.z <- scale(k1_df$ses.lad.now)

k1_df$ses.lad.y2[k1_df$ses.lad.y2 < 0] <- NA
k1_df$ses.lad.y2.z <- scale(k1_df$ses.lad.y2)

k1_df$ses.lad.diff <- k1_df$ses.lad.y2 - k1_df$ses.lad.now
k1_df$ses.lad.avg <- (k1_df$ses.lad.y2 + k1_df$ses.lad.now) / 2

## Sociodemographics ##

k1_df$soc.age[k1_df$soc.age < 0] <- NA

k1_df$soc.pri <- as.numeric(k1_df$soc.edu > 3)

k1_df$soc.fem <- k1_df$soc.gen - 1
k1_df$soc.fem[k1_df$soc.fem < 0] <- NA

k1_df$soc.chr <- k1_df$soc.rel %in% c(1, 2)

k1_df$ses.unemp <- k1_df$ses.emp %in% c(1, 2)

k1_df$soc.inc[k1_df$soc.inc < 0] <- NA
k1_df$soc.inc.wins[k1_df$soc.inc <= quantile(k1_df$soc.inc, .99)] <- k1_df$soc.inc[k1_df$soc.inc <= quantile(k1_df$soc.inc, .99)]
k1_df$soc.inc.wins.ln <- log(k1_df$soc.inc.wins + sqrt(k1_df$soc.inc.wins^2 + 1))

k1_df$soc.con[k1_df$soc.con < 0] <- NA
k1_df$soc.con.wins[k1_df$soc.con <= quantile(k1_df$soc.con, .99)] <- k1_df$soc.con[k1_df$soc.con <= quantile(k1_df$soc.con, .99)]
k1_df$soc.con.wins.ln <- log(k1_df$soc.con.wins + sqrt(k1_df$soc.con.wins^2 + 1))

k1_df$soc.sav <- k1_df$soc.sav - 1

k1_df$soc.eme.z <- scale(k1_df$soc.eme)

## Survey validity ##

k1_df$end.hear <- k1_df$end.hear - 1
k1_df$end.hear[k1_df$end.hear < 0] <- NA

## Center covariates ##

k1_df$soc.fem.c <- scale(k1_df$soc.fem, scale = FALSE)
k1_df$soc.pri.c <- scale(k1_df$soc.pri, scale = FALSE)
k1_df$soc.age.c <- scale(k1_df$soc.age, scale = FALSE)
k1_df$ses.unemp.c <- scale(k1_df$ses.unemp, scale = FALSE)

write.csv(k1_df, file = "K1_Data.csv", na = "")
attach(k1_df)
```

# Analysis

## Descriptive Stats

```{r}
table(k1_df$soc.fem)
summary(k1_df$soc.edu)
hist(k1_df$soc.edu)
```


## DV1: Videos

```{r}
## Binary: Skills vs. No Skills Videos
ms.vid.skills <- k1_df %>%  ## Troubleshooting: could add: `k1_df[,1:180]` to SELECT COLUMN I CARE ABOUT and remove problematic ones
  # dplyr::select(vid.skills, condition) %>% ## SELECT COLUMN I CARE ABOUT FIRST
  group_by(condition.order) %>%
  summarise(perc.vid = mean(vid.skills), sd(vid.skills), "ci" =ci(vid.skills), ci.lo = perc.vid - ci, ci.hi = perc.vid + ci) %>%
  ungroup()
kable(ms.vid.skills, digits=3)

ggplot(ms.vid.skills, aes(x=condition.order, y=perc.vid, fill=condition.order)) +
  geom_bar(position="dodge", stat="identity", width=0.9) +
 geom_errorbar(aes(ymin=ci.lo, ymax=ci.hi),  
 width=0.2, position=position_dodge(0.9)) +
  coord_cartesian() +
    theme(text = element_text(size=13, face="bold")) +
    scale_fill_brewer(palette="Paired") + 
  theme(axis.text.x = element_text(face="bold", size=rel(1.3))) + 
    labs(fill='Condition') +
  # geom_signif(comparisons=list(c("Poverty", "Community")), annotations="p=.014",
  #             y_position = 1.7, tip_length = .1, vjust=0.2) +
  #   geom_signif(comparisons=list(c("Poverty", "Individual")), annotations="p=.078",
  #             y_position = 1.5, tip_length = .1, vjust=-0.2) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  xlab("Message Condition") +
  ylab("Percent Selecting Skills Building Videos") +
  ggtitle("Self-Investment Behaviors")
```


```{r}
## Ordinal: No. Skills Videos

ms.vid2 <- k1_df %>% 
  dplyr::select(vid.num, condition.order, survey.id) %>%
  dplyr::group_by(condition.order) %>% 
  dplyr::summarise(
    Mean_Num_Vid = mean(vid.num), 
              sd=sd(vid.num), 
    n_observations = length(survey.id), "ci" =ci(vid.num), ci.lo = Mean_Num_Vid - ci, ci.hi = Mean_Num_Vid + ci) 
kable(ms.vid2, digits=3) 


#               mean.vid.num                  sd
# |community  |        1.376|              0.703|
# |individual |        1.333|              0.748|
# |poor       |        1.196|              0.736|

ggplot(ms.vid2, aes(x=condition.order, y=Mean_Num_Vid, fill=condition.order)) +
  geom_bar(position="dodge", stat="identity", width=0.9) +
 geom_errorbar(aes(ymin=ci.lo, ymax=ci.hi),  
 width=0.2, position=position_dodge(0.9)) +
  coord_cartesian() +
    theme(text = element_text(size=13, face="bold")) +
    scale_fill_brewer(palette="Paired") + 
  theme(axis.text.x = element_text(face="bold", size=rel(1.3))) + 
    labs(fill='Condition') +
  geom_signif(comparisons=list(c("Poverty", "Community")), annotations="p=.014"",
              y_position = 1.7, tip_length = .1, vjust=0.2) +
    geom_signif(comparisons=list(c("Poverty", "Individual")), annotations="p=.078",
              y_position = 1.5, tip_length = .1, vjust=-0.2) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  xlab("Message Condition") +
  ylab("No. Skills Building Videos Selected") +
  ggtitle("Self-Investment Behaviors")
```


```{r}
# dep vars to control for: soc.fem.c", "soc.pri.c", "soc.age.c", "ses.unemp.c
mod <- lm(vid.num ~ condition + soc.fem.c + soc.pri.c + soc.age.c + ses.unemp.c, data = k1_df)
print(summary(mod))
kable(tidy(mod), digits = 3)

# |term                | estimate| std.error| statistic| p.value|
# |:-------------------|--------:|---------:|---------:|-------:|
# |(Intercept)         |    1.362|     0.050|    27.349|   0.000|
# |conditionindividual |   -0.016|     0.073|    -0.222|   0.825|
# |conditionpoor       |   -0.162|     0.072|    -2.261|   0.024|
# |soc.fem.c           |    0.262|     0.063|     4.149|   0.000|
# |soc.pri.c           |    0.073|     0.094|     0.782|   0.434|
# |soc.age.c           |    0.015|     0.004|     3.903|   0.000|
# |ses.unemp.c         |   -0.053|     0.066|    -0.810|   0.418|

mod <- lm(vid.num ~ condition.order*soc.fem.c, data = k1_df)
print(summary(mod))
```


## Savings

```{r}
ms.sav <- k1_df %>% 
  group_by(condition) %>% 
  summarise("Mean_Savings" = mean(sav.amt, na.rm=TRUE), sd=sd(sav.amt, na.rm=TRUE))
  # mutate(vid.perc = ifelse(vid.num >= 1))
kable(ms.sav, digits=3) 

summary(lm(sav.amt ~ condition.order, data=k1_df)) # no ATE
```

## Message of Support 

```{r}
ms.msg.dec <- k1_df %>% 
  group_by(condition.order) %>%
  summarise(perc.msg.dec = mean(msg.dec), sd(msg.dec), "ci" =ci(msg.dec), ci.lo = perc.msg.dec - ci, ci.hi = perc.msg.dec + ci) %>%
  ungroup()
kable(ms.msg.dec, digits=3)

summary(glm(msg.dec ~ condition.order, data=k1_df, family = binomial)) # no ATE
```

## MEDIATORS

```{r}
### Self-Efficacy ### 
# predicts video selection
summary(lm(vid.num ~ sel.score.z, data=k1_df)) # p=0.03
summary(lm(vid.num ~ sel.pers, data=k1_df)) # ns
summary(lm(vid.num ~ sel.com, data=k1_df)) # ns
summary(lm(vid.num ~ sel.con, data=k1_df)) # p=0.002, control of finances
summary(lm(vid.num ~ sel.prob, data=k1_df)) # ns
summary(lm(vid.num ~ sel.bett, data=k1_df)) # ns

summary(lm(sel.score.z ~ condition, data=k1_df)) # for poor: p=0.009
summary(lm(sel.pers~ condition, data=k1_df)) # for poor: p=0.049
summary(lm(sel.com~ condition, data=k1_df)) # for poor: p=0.047
summary(lm(sel.con ~ condition, data=k1_df)) # for poor: p=0.0297
summary(lm(sel.prob ~ condition, data=k1_df)) # for poor: p=0.09
summary(lm(sel.bett ~ condition, data=k1_df)) # ns
```

```{r}
# Absolute values of means by condition
ms.sel <- k1_df %>% 
  group_by(condition.order) %>% 
  summarise("Mean_SelfEfficacy" = mean(sel.abs, na.rm=TRUE)) %>%
  ungroup()
kable(ms.sel, digits=3) 

ms.sti <- k1_df %>% 
  group_by(condition.order) %>% 
  summarise("Mean_Stigma" = mean(sti.abs, na.rm=TRUE)) %>%
  ungroup()
kable(ms.sti, digits=3) 

ms.lad <- k1_df %>% 
  group_by(condition.order) %>% 
  summarise("Mean_Ladder" = mean(ses.lad.now, na.rm=TRUE)) %>%
  ungroup()
kable(ms.lad, digits=3) 
```

```{r}
### Stigma ### 
# marginally predicts video selection
summary(lm(vid.num ~ sti.score.z, data=k1_df)) # p=0.06
# predicts video selection
summary(lm(vid.num ~ jud.judg, data=k1_df)) # ns
summary(lm(vid.num ~ jud.emb, data=k1_df)) # ns
summary(lm(vid.num ~ jud.ups, data=k1_df)) # ns
summary(lm(vid.num ~ jud.fam, data=k1_df)) # p=0.03, are a good family member
summary(lm(vid.num ~ jud.com, data=k1_df)) # ns

mean(k1_df$por.help, na.rm=TRUE)
# [1] 1.497354
mean(k1_df$ind.help, na.rm=TRUE)
# [1] 1.477011
mean(k1_df$com.help, na.rm=TRUE)
# [1] 1.554455

```

```{r}
### AFFECT ### 
summary(lm(aff.score.z ~ condition, data=k1_df)) 
# ns
summary(lm(vid.num ~ aff.score.z, data=k1_df))
# p=0.00121 
```

```{r}
### SES ### 
## not related to video, predicted by self-efficacy
summary(lm(vid.num ~ ses.lad.now, data=k1_df))
# ns
summary(lm(vid.num ~ ses.lad.y2, data=k1_df))
# ns
summary(lm(ses.lad.now ~ sel.score, data=k1_df))
# p<0.001, SELF-EFFICACY PREDICTS SUBJECTIVE SES
summary(lm(ses.lad.y2 ~ sel.score, data=k1_df))
# p<0.001, SELF-EFFICACY PREDICTS SUBJECTIVE SES
summary(lm(ses.lad.now.z ~ sti.score.z, data=k1_df))
# ns
```


################
## Estimation ##
################

## Randomization balance checks ##

hypotheses <- c("treatInd = 0", "treatCom = 0", "treatInd - treatCom = 0")
depvars <- c("soc.fem", "soc.pri", "soc.age", "ses.unemp", "soc.inc.wins.ln", "soc.con.wins.ln", "soc.sav")

for (h in hypotheses) {

    RES <- matrix(nrow = 1, ncol = 5)

    for (depvar in depvars) {

        eqn <- paste(depvar, "~ treat", sep = " ")
        RES <- rbind(RES, PermTest(eqn, treatvars = c("treat", "pov", "ind", "com"), clustvars = k1_df$survey.id, hypotheses = c(h), iterations = 10, data = k1_df))

    }

    RES <- RES[2:nrow(RES), 1:ncol(RES)]
    RES <- cbind(RES, FDR(RES[, 4]))

    rownames(RES) <- depvars
    colnames(RES)[6] <- "Min. Q"

    print("----------------------------------------------------------------", quote = FALSE)
    print(paste("H_0:", h), quote = FALSE)
    print(RES, quote = FALSE)

}

## Plain OLS for primary outcomes ##

hypotheses <- c("treatInd = 0", "treatCom = 0", "treatInd - treatCom = 0")
depvars <- c("vid.num", "sav.amt", "msg.dec")

for (h in hypotheses) {

    RES <- matrix(nrow = 1, ncol = 5)

    for (depvar in depvars) {

        eqn <- paste(depvar, "~ treat", sep = " ")
        RES <- rbind(RES, PermTest(eqn, treatvars = c("treat", "pov", "ind", "com"), clustvars = k1_df$survey.id, hypotheses = c(h), iterations = 10, data = k1_df))

    }

    RES <- RES[2:nrow(RES), 1:ncol(RES)]
    RES <- cbind(RES, FDR(RES[, 4]))

    rownames(RES) <- depvars
    colnames(RES)[6] <- "Min. Q"

    print("----------------------------------------------------------------", quote = FALSE)
    print(paste("H_0:", h), quote = FALSE)
    print(RES, quote = FALSE)

}

## Plain OLS for secondary outcomes ##

hypotheses <- c("treatInd = 0", "treatCom = 0", "treatInd - treatCom = 0")
depvars <- c("sel.score.z", "sti.score.z", "aff.score.z", "msg.avg", "que.smrd", "ses.lad.now.z", "ses.lad.y2.z", "ses.lad.diff")

for (h in hypotheses) {

    RES <- matrix(nrow = 1, ncol = 5)

    for (depvar in depvars) {

        eqn <- paste(depvar, "~ treat", sep = " ")
        RES <- rbind(RES, PermTest(eqn, treatvars = c("treat", "pov", "ind", "com"), clustvars = k1_df$survey.id, hypotheses = c(h), iterations = 10, data = k1_df))

    }

    RES <- RES[2:nrow(RES), 1:ncol(RES)]
    RES <- cbind(RES, FDR(RES[, 4]))

    rownames(RES) <- depvars
    colnames(RES)[6] <- "Min. Q"

    print("----------------------------------------------------------------", quote = FALSE)
    print(paste("H_0:", h), quote = FALSE)
    print(RES, quote = FALSE)

}

## Covariate adjustment for primary outcomes ##

hypotheses <- c("treatInd = 0", "treatCom = 0", "treatInd - treatCom = 0")
depvars <- c("vid.num", "sav.amt", "msg.dec")
covariates <- c("soc.fem.c", "soc.pri.c", "soc.age.c", "ses.unemp.c")

for (h in hypotheses) {

    RES <- matrix(nrow = 1, ncol = 5)

    for (depvar in depvars) {

        eqn <- paste(depvar, "~", Interact("treat", covariates), sep = " ")
        RES <- rbind(RES, PermTest(eqn, treatvars = c("treat", "pov", "ind", "com"), clustvars = k1_df$survey.id, hypotheses = c(h), iterations = 10, data = k1_df))

    }

    RES <- RES[2:nrow(RES), 1:ncol(RES)]
    RES <- cbind(RES, FDR(RES[, 4]))

    rownames(RES) <- depvars
    colnames(RES)[6] <- "Min. Q"

    print("----------------------------------------------------------------", quote = FALSE)
    print(paste("H_0:", h), quote = FALSE)
    print(RES, quote = FALSE)

}

## Covariate adjustment for secondary outcomes ##

hypotheses <- c("treatInd = 0", "treatCom = 0", "treatInd - treatCom = 0")
depvars <- c("sel.score.z", "sti.score.z", "aff.score.z", "msg.avg", "que.smrd", "ses.lad.now.z", "ses.lad.y2.z", "ses.lad.diff")
covariates <- c("soc.fem.c", "soc.pri.c", "soc.age.c", "ses.unemp.c")

for (h in hypotheses) {

    RES <- matrix(nrow = 1, ncol = 5)

    for (depvar in depvars) {

        eqn <- paste(depvar, "~", Interact("treat", covariates), sep = " ")
        RES <- rbind(RES, PermTest(eqn, treatvars = c("treat", "pov", "ind", "com"), clustvars = k1_df$survey.id, hypotheses = c(h), iterations = 10, data = k1_df))

    }

    RES <- RES[2:nrow(RES), 1:ncol(RES)]
    RES <- cbind(RES, FDR(RES[, 4]))

    rownames(RES) <- depvars
    colnames(RES)[6] <- "Min. Q"

    print("----------------------------------------------------------------", quote = FALSE)
    print(paste("H_0:", h), quote = FALSE)
    print(RES, quote = FALSE)

}

## Heterogeneous effects for primary outcomes ##

depvars <- c("vid.num", "sav.amt", "msg.dec")
hetvars <- c("soc.fem", "soc.pri")

for (hetvar in hetvars) {

    hypotheses <- c(paste("treatInd:", hetvar, " = 0", sep = ""), paste("treatCom:", hetvar, " = 0", sep = ""), paste("treatInd:", hetvar, " - ", "treatCom:", hetvar, " = 0", sep = ""))

    for (h in hypotheses) {

        RES <- matrix(nrow = 1, ncol = 5)

        for (depvar in depvars) {

            eqn <- paste(depvar, " ~ treat*", hetvar, sep = "")
            RES <- rbind(RES, PermTest(eqn, treatvars = c("treat", "pov", "ind", "com"), clustvars = k1_df$survey.id, hypotheses = c(h), iterations = 10, data = k1_df))

        }

        RES <- RES[2:nrow(RES), 1:ncol(RES)]
        RES <- cbind(RES, FDR(RES[, 4]))

        rownames(RES) <- depvars
        colnames(RES)[6] <- "Min. Q"

        print("----------------------------------------------------------------", quote = FALSE)
        print(paste("H_0:", h), quote = FALSE)
        print(RES, quote = FALSE)

    }

}

## Heterogeneous effects for secondary outcomes ##

depvars <- c("sel.score.z", "sti.score.z", "aff.score.z", "msg.avg", "que.smrd", "ses.lad.now.z", "ses.lad.y2.z", "ses.lad.diff")
hetvars <- c("soc.fem", "soc.pri")

for (hetvar in hetvars) {

    hypotheses <- c(paste("treatInd:", hetvar, " = 0", sep = ""), paste("treatCom:", hetvar, " = 0", sep = ""), paste("treatInd:", hetvar, " - ", "treatCom:", hetvar, " = 0", sep = ""))

    for (h in hypotheses) {

        RES <- matrix(nrow = 1, ncol = 5)

        for (depvar in depvars) {

            eqn <- paste(depvar, " ~ treat*", hetvar, sep = "")
            RES <- rbind(RES, PermTest(eqn, treatvars = c("treat", "pov", "ind", "com"), clustvars = k1_df$survey.id, hypotheses = c(h), iterations = 10, data = k1_df))

        }

        RES <- RES[2:nrow(RES), 1:ncol(RES)]
        RES <- cbind(RES, FDR(RES[, 4]))

        rownames(RES) <- depvars
        colnames(RES)[6] <- "Min. Q"

        print("----------------------------------------------------------------", quote = FALSE)
        print(paste("H_0:", h), quote = FALSE)
        print(RES, quote = FALSE)

    }

}

## Errata identified ##

## Errata resolved ##
    # treatCom = 1
    # soc.fem has -100 value
    # covariates were not being centered properly
    # ladder scales not standardized
    # error with FDR()
